SELECT user_id, games.season_id, sum(CASE WHEN position != 'G' THEN goals END) "goals", sum(CASE WHEN position != 'G' THEN assists END) "assists", sum(CASE WHEN position != 'G' THEN goals END) + sum(CASE WHEN position != 'G' THEN assists END) "points", COUNT(CASE WHEN position != 'G' THEN 1 END) "games_played", coalesce((sum(CASE WHEN position != 'G' THEN goals END) + sum(CASE WHEN position != 'G' THEN assists END))::FLOAT / NULLIF(COUNT(*),0), 0) "p_per", COUNT(CASE WHEN position = 'G' THEN 1 END) "goalie_games", sum(CASE WHEN position != 'G' THEN plus_minus END) "plus_minus", sum(CASE WHEN position != 'G' THEN pim END) "pim", sum(ppg) "ppg", sum(shg) "shg", sum(shots) "shots", sum(hits) "hits", coalesce(CAST(sum(goals) as FLOAT) / NULLIF(sum(shots),0), 0) "sh_per", sum(fow) "fow", sum(fot) "fot", coalesce(sum(fow)::FLOAT / NULLIF(sum(fot),0), 0) "fo_per", sum(goals_against) "ga", sum(shots_against) "sa", coalesce((sum(shots_against) - sum(goals_against))::FLOAT / NULLIF(sum(shots_against), 0), 0) "sv_per", coalesce(sum(goals_against)::FLOAT / NULLIF(count(CASE WHEN position = 'G' THEN 1 END), 0), 0) "gaa", count(CASE WHEN goals_against = 0 AND position = 'G' THEN 1 END) "so", sum(CASE WHEN position = 'G' THEN assists ELSE 0 END) "g_assists", sum(CASE WHEN position = 'G' THEN goals ELSE 0 END) "g_goals"
FROM stat_lines inner join games on stat_lines.game_id = games.id
WHERE final=true
GROUP BY user_id, games.season_id
ORDER BY user_id, games.season_id;
